pattern CVE-2018-21000

use {
    std::vec::Vec
	std::mem::size_of
	std::mem::forget
}

util {
    p_reversed_para(
        T1: ty
        T2: ty
        T3: ty
        op: binop
    ) = pub fn _ (..) -> _ {
        @let $vec: Vec<$T1> = _;
        @let $size = size_of::<$T2>();
        @let $cap = $op($vec.capacity(), $size);
        @let $len = $op($vec.len(), $size);
        @let $ptr = $vec.as_mut_ptr();
        @let $ptr = $ptr as *mut $T3;
        forget($vec);
        @let _ = Vec::from_raw_parts($ptr, $cap, $len)
    }
}

patt {
    p1(
        T: ty
    ) = p_reversed_para(
        T1 = u8
        T2 = T
        T3 = T
        op = /
    )

    p2(
        T: ty
    ) = p_reversed_para(
        T1 = T
        T2 = T
        T3 = u8
        op = *
    )
}


