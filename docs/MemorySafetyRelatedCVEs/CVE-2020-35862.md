# CVE-2020-35862

## Metadata

- RustSec: https://rustsec.org/advisories/RUSTSEC-2020-0007.html
- Mitre: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-35862
- Bug Report GitHub Issue/Release:
  - https://github.com/ferrilab/bitvec/issues/55
  - https://github.com/mesalock-linux/bitvec-sgx/commit/b8c2ec36dce7aa57445cafba2c4bbb4ba2d664d0
- Bug Fix GitHub Commit/PR: https://github.com/mesalock-linux/bitvec-sgx/commit/b8c2ec36dce7aa57445cafba2c4bbb4ba2d664d0

## Source

```rust
impl<O, T> Drop for BitBox<O, T>
where O: BitOrder, T: BitStore {
	fn drop(&mut self) {
		let ptr = self.as_mut_slice().as_mut_ptr();
		let len = self.as_slice().len();
		//  Run the `Box<[T]>` destructor.
		drop(unsafe { Vec::from_raw_parts(ptr, 0, len) }.into_boxed_slice());
	}
}
```

## Description / Analysis

Specifically, `BitBox` relied on an incorrect assumption that,`Vec::into_boxed_slice` never moved the base address during resizing.

```rust
pub fn into_boxed_slice(mut self) -> Box<[T], A> {
    unsafe {
        self.shrink_to_fit();
        let me = ManuallyDrop::new(self);
        let buf = ptr::read(&me.buf);
        let len = me.len();
        buf.into_box(len).assume_init()
    }
}
```

`shrink_to_fit()` shrinks the capacity of the vector as much as possible.

The behavior of this method depends on the allocator, which may either shrink the vector in-place or **reallocate**. The resulting vector might still have some excess capacity, just as is the case for with_capacity. See Allocator::shrink for more details.


## Fixes

```rust
impl<O, T> Drop for BitBox<O, T>
where O: BitOrder, T: BitStore {
	fn drop(&mut self) {
		let bp = self.bitptr();
		let ptr = bp.pointer().w();
		let len = bp.elements();
		let slice = unsafe { slice::from_raw_parts_mut(ptr, len) };
		drop(unsafe { Box::from_raw(slice as *mut [_]) })
	}
}
```

## Pattern Description

TODO

## References

- Shrink in raw_vec: https://doc.rust-lang.org/beta/src/alloc/raw_vec.rs.html#533
- Shrink in Allocator: https://doc.rust-lang.org/std/alloc/trait.Allocator.html#method.shrink
- Shrink in Vec: https://doc.rust-lang.org/std/vec/struct.Vec.html#method.shrink_to_fit
- A StackOverflow discussion: https://stackoverflow.com/questions/76308441/how-does-stdvecshrink-to-fit-work-in-rust
