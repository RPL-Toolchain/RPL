# CVE-2021-27376

## Metadata

- RustSec: https://rustsec.org/advisories/RUSTSEC-2021-0021.html
- Mitre: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27376
- Bug Report GitHub Issue/Release: https://github.com/smol-rs/nb-connect/issues/1 
- Bug Fix GitHub Commit/PR: TODO

## Source

Modified.

```rust
extern crate libc;

use libc::{sockaddr, sockaddr_storage, socklen_t};
use std::mem::{self, MaybeUninit};
use std::net::{SocketAddr, SocketAddrV4, SocketAddrV6};
use std::ptr;

struct Addr {
    storage: sockaddr_storage,
    len: socklen_t,
}

impl Addr {
    /// Creates a raw socket address from `SocketAddr`.
    fn new(addr: std::net::SocketAddr) -> Self {
        let (addr, len): (*const sockaddr, socklen_t) = match &addr {
            SocketAddr::V4(addr) => (
                addr as *const SocketAddrV4 as *const sockaddr,
                mem::size_of_val(addr) as socklen_t,
            ),
            SocketAddr::V6(addr) => (
                addr as *const SocketAddrV6 as *const sockaddr,
                mem::size_of_val(addr) as socklen_t,
            ),
        };
        unsafe { Self::from_raw_parts(addr, len) }
    }

    /// Creates an `Addr` from its raw parts.
    unsafe fn from_raw_parts(addr: *const sockaddr, len: socklen_t) -> Self {
        let mut storage = MaybeUninit::<sockaddr_storage>::uninit();
        ptr::copy_nonoverlapping(
            addr as *const u8,
            &mut storage as *mut MaybeUninit<sockaddr_storage> as *mut u8,
            len as usize,
        );
        Self {
            storage: storage.assume_init(),
            len,
        }
    }
}

```

## Description / Analysis

```rust
pub struct SocketAddrV4 {
    ip: Ipv4Addr,
    port: u16,
}

pub struct Ipv4Addr {
    octets: [u8; 4],
}
```

```rust
pub struct sockaddr {
    pub sa_len: u8,
    pub sa_family: sa_family_t,
    pub sa_data: [::c_char; 14],
}
```

The crate has assumed `std::net::SocketAddrV4` and `std::net::SocketAddrV6` have the same memory layout as the system C representation `libc::sockaddr`.

It has simply casted the pointers to convert the socket addresses to the system representation.

The standard library does not say anything about the memory layout, and this will cause **invalid memory access** if the standard library changes the implementation.

## Fixes

remove all vulnerable code, use a new approach `socket2` crate.

## Pattern Description

TODO

## References

Rust Issue:
https://github.com/rust-lang/rust/pull/78802/commits/2e6256b2431c3b3713fa33ab46f293dbd07dec93#diff-739a4fdf633ba2ba38cc427c8a77f703e6dc9d99f059103f84d0bc64d99bf587R81
