# CVE-2021-25904

## Metadata

- RustSec: https://rustsec.org/advisories/RUSTSEC-2021-0007.html
- Mitre: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-25904
- Bug Report GitHub Issue/Release: https://github.com/rust-av/rust-av/issues/136
- Bug Fix GitHub Commit/PR: https://github.com/rust-av/rust-av/pull/137/commits/b6edd59e9b1f9e52791ef06e6e63cce97b8f5f32

## Source

```rust
pub fn copy_from_raw_parts<I, IU>(&mut self, mut src: I, mut src_linesize: IU)
    where
        I: Iterator<Item = *const u8>,
        IU: Iterator<Item = usize>,
    {
        if let MediaKind::Video(ref fmt) = self.kind {
            let mut f_iter = fmt.format.iter();
            let width = fmt.width;
            let height = fmt.height;
            for i in 0..self.buf.count() {
                let d_linesize = self.buf.linesize(i).unwrap();
                let s_linesize = src_linesize.next().unwrap();
                let data = self.buf.as_mut_slice(i).unwrap();
                let cc = f_iter.next().unwrap();
                let rr = src.next().unwrap(); // here
                let hb = cc.unwrap().get_height(height);
                let ss = unsafe { slice::from_raw_parts(rr, hb * s_linesize) }; // here
                copy_plane(
                    data,
                    d_linesize,
                    ss,
                    s_linesize,
                    cc.unwrap().get_width(width),
                    hb,
                );
            }
        } else {
            unimplemented!();
        }
    }
}
```

## Description / Analysis

The `std::slice::from_raw_parts`'s safety requirements are not met:

- **data(the pointer) must be non-null and aligned even for zero-length slices. **

## Fixes

The vulnerable function is removed.

## Pattern Description

````rpl
pattern CVE-2021-25904

mvar {
    raw_slice: span
}

util {
    p_from_raw_parts = pub fn _(_) -> _ {
        let ptr: *const _ = _;
        #without!(if !ptr.is_null()) {
            unsafe { #span!($raw_slice, from_raw_parts(ptr, _)) };
        }
    }
}

patt {
    p: warn = p_from_raw_parts => SliceFromNullablePtr {
        $raw_slice,
    }
}

use {
    core::slice::from_raw_parts
}

diag {
    #[derive(Diagnostic)]
    #[diag(slice_from_nullable_ptr)]
    pub struct SliceFromNullablePtr {
        #[primary_span]
        pub raw_slice: Span,
    }
}

msg {
    slice_from_nullable_ptr = construct a slice from a nullable pointer
}
````

## References

`std::slice::from_raw_parts`: https://doc.rust-lang.org/std/slice/fn.from_raw_parts.html
