pattern CVE-2020-35860

patt {
    use std::ffi::CStr;

    p_deref_null_pointer[
        $T: type
    ] = {
        struct $CBox {
            $ptr: *mut $T,
        }

        fn $pattern(..) -> _ {
            let $self: &$CBox;
            'ptr:
            let $self_ptr: *mut $T = copy (*$self).$ptr;
            let $ptr: *const i8 = move $self_ptr as *const i8 (PtrToPtr);
            'deref:
            _ = CStr::from_ptr::<'_>(move $ptr);
        }
    }
}

diag {
    p_deref_null_pointer = {
        primary(deref) = "Dereference of a possibly null pointer",
        label(ptr)     = "pointer created here",
        label(deref)   = "dereference here",
        note           = "this is because the pointer may be null",
        name           = "deref_null_pointer",
        level          = "deny",
    }
}
