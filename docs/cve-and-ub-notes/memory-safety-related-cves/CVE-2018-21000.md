# CVE-2018-21000

## Metadata

- RustSec: https://rustsec.org/advisories/RUSTSEC-2018-0013.html
- Mitre: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-21000
- Bug Report GitHub Issue/Release: https://github.com/nabijaczleweli/safe-transmute-rs/pull/36
- Bug Fix GitHub Commit/PR: https://github.com/nabijaczleweli/safe-transmute-rs/pull/36

## Source

```rust
use std::mem::{size_of, forget};
use std::vec::Vec;

pub unsafe fn guarded_transmute_vec_permissive<T>(mut bytes: Vec<u8>) -> Vec<T> {
    // PermissiveGuard::check::<T>(&bytes).unwrap();
    let ptr = bytes.as_mut_ptr();
    let capacity = bytes.capacity() / size_of::<T>();
    let len = bytes.len() / size_of::<T>();
    forget(bytes);
    Vec::from_raw_parts(ptr as *mut T, capacity, len)
}

pub unsafe fn guarded_transmute_to_bytes_vec<T>(mut from: Vec<T>) -> Vec<u8> {
    let capacity = from.capacity() * size_of::<T>();
    let len = from.len() * size_of::<T>();
    let ptr = from.as_mut_ptr();
    forget(from);
    Vec::from_raw_parts(ptr as *mut u8, capacity, len)
}
```

## Description / Analysis

The order of `capacity` and `len` in `Vec::from_raw_parts` is incorrect.

## Fixes

The order of `capacity` and `len` in `Vec::from_raw_parts` should be corrected.

## Pattern Description

Wrong order.

````rpl
pattern CVE-2018-21000

mvar {
    T1: ty
    T2: ty
    op: binop
    expr: span
    cap: span
    len: span
}

util {
    p1 = ?pub ?unsafe fn _(_) -> _ {
        let vec: Vec<$T1> = _;
        let size: usize = size_of::<$T2>();
        let cap: usize = vec.capacity() $op size;
        let len: usize = vec.len() $op size;
        let ptr: *mut $T1 = vec.as_mut_ptr();
        let ptr: *mut $T2 = ptr as *mut $T2;
        forget(vec);
        let target: Vec<$T2> = unsafe {
            #span!($expr, Vec::from_raw_parts(ptr, #span!($cap, cap), #span!($len, len)))
        };
    }
}

patt {
    p: err =
        | p1 { T2 = `u8`, op = `*` }
        | p1 { T1 = `u8`, op = `/` }
        => FromRawPartsError {
            $expr,
            sugg: SwapCapLenSugg {
                cap_span: $cap,
                len_span: $len,
                cap: snippet($cap),
                len: snippet($len),
            },
        }
}

use {
    std::vec::Vec
	std::mem::size_of
	std::mem::forget
}

diag {
    #[derive(Diagnostic)]
    #[diag(from_raw_parts_error)]
    pub struct FromRawPartsError {
        #[primary_span]
        pub expr: Span,
        #[subdiagnostic]
        pub sugg: SwapCapLenSugg,
    }

    #[derive(Subdiagnostic)]
    #[multipart_suggestion(swap_cap_len_sugg)]
    pub struct SwapCapLenSugg {
        #[suggestion_part(code = "{len}")]
        pub cap_span: Span,
        #[suggestion_part(code = "{cap}")]
        pub len_span: Span,
        pub cap: String,
        pub len: String,
    }
}

msg {
    from_raw_parts_error = wrong order in passing `len` and `cap` parameters
    swap_cap_len_sugg = try swapping these two arguments
}
````