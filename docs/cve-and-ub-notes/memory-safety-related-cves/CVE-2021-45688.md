# CVE-2021-45688

## Metadata

-   RustSec: TODO
-   Mitre: TODO
-   Bug Report GitHub Issue/Release:
    -   https://github.com/advisories/GHSA-64wv-8vwp-xgw2
    -   https://github.com/ash-rs/ash/issues/354
-   Bug Fix GitHub Commit/PR: https://github.com/ash-rs/ash/pull/470/commits/ea809ba4ae37c4b0de54158e05699f1907c9e83e
-   Bug position: https://github.com/ash-rs/ash/blob/7fa182cc4330da8da98a7c023049162a4979d0bf/ash/src/util.rs#L116-L124

## Source

```rust
pub fn read_spv<R: io::Read + io::Seek>(x: &mut R) -> io::Result<Vec<u32>> {
    let size = x.seek(io::SeekFrom::End(0))?;
    if size % 4 != 0 {
        return Err(io::Error::new(
            io::ErrorKind::InvalidData,
            "input length not divisible by 4",
        ));
    }
    if size > usize::max_value() as u64 {
        return Err(io::Error::new(io::ErrorKind::InvalidData, "input too long"));
    }
    let words = (size / 4) as usize;
    let mut result = Vec::<u32>::with_capacity(words);
    x.seek(io::SeekFrom::Start(0))?;
    unsafe {
        x.read_exact(slice::from_raw_parts_mut(
            result.as_mut_ptr() as *mut u8,
            words * 4,
        ))?;
        result.set_len(words);
    }
    const MAGIC_NUMBER: u32 = 0x0723_0203;
    if !result.is_empty() && result[0] == MAGIC_NUMBER.swap_bytes() {
        for word in &mut result {
            *word = word.swap_bytes();
        }
    }
    if result.is_empty() || result[0] != MAGIC_NUMBER {
        return Err(io::Error::new(
            io::ErrorKind::InvalidData,
            "input missing SPIR-V magic number",
        ));
    }
    Ok(result)
}
```

## Description / Analysis

Possibly read from uninitialized memory in `read_spv` function in `util.rs` file.

## Fixes

Remove the `set_len` call and use `vec![0; words]` to initialize the vector.

```rust
let mut result = vec![0u32; words];
x.seek(io::SeekFrom::Start(0))?;
x.read_exact(unsafe { slice::from_raw_parts_mut(result.as_mut_ptr() as *mut u8, words * 4) })?;
```