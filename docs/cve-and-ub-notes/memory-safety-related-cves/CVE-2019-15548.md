# CVE-2019-15548

## Metadata

- RustSec: https://rustsec.org/advisories/RUSTSEC-2019-0006.html
- Mitre: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-15548
- Bug Report GitHub Issue/Release: 
  - https://github.com/jeaye/ncurses-rs/issues/186
  - https://github.com/rustsec/advisory-db/issues/106
- Bug Fix GitHub Commit/PR: 
  - (partly) https://github.com/jeaye/ncurses-rs/pull/216/commits

## What does `ncurses` mean?

- `n` means new
- `curses` is a terminal control library for Unix-like systems, enabling the construction of text user interface (TUI) applications. The name "curses" is a pun on the term "cursor optimization"
  - curse?
  - cursor?

## Source

```rust
// cargo.toml
[lib] //The library target defines a “library” that can be used and linked by other libraries and executables.
name = "ncurses"
```

```rust
// src/ll.rs

/*
Copyright © 2013 ... Author: Jesse 'Jeaye' Wilkerson
Description:
Low-level interface to foreign
ncurses functions.
*/

use libc::{ c_char, c_int, c_short, c_uint, c_ulong, c_void, FILE };

/* Pointer types. */
pub type char_p = *const c_char;

extern {
    ...
    pub fn instr(_:char_p) -> c_int;
    ...
}
```

```rust
// src/panel/lib.rs
pub fn instr(s: &mut String) -> i32
{
    /* XXX: This is probably broken. */
    unsafe
    {
        let buf = s.as_bytes().as_ptr(); 
        //as_bytes returns a byte slice(&[u8]) of this String’s contents.
        //as_ptr returns a raw pointer to the slice’s buffer.
        let ret = ll::instr(mem::transmute(buf));


        let capacity = s.capacity();
        match s.find('\0')
        {
            Some(index) => s.as_mut_vec().set_len(index as usize),
            None => s.as_mut_vec().set_len(capacity),
        }
        ret
    }
}
```

## Description / Analysis

```c
int instr(char * str);
```

- description: `instr` extracts a string from a curses window, starting at the cursor and  stopping at the end of the line.
- why dangerous: Pass buffers without length to C functions `instr` that may write an arbitrary amount of data, leading to a buffer overflow. (like `gets`/`strcpy` in C)

## Fixes

The function has been removed on Mar 31, 2024.

## Pattern Description

````rpl
pattern CVE-2019-15548-instr

mvar {
    api: fn
    call: span
}

util {
    p_api = extern "C" ?pub unsafe fn $api(*mut c_char) -> _;
    p_call = ?pub ?unsafe fn _(_) -> _ {
        let ret: _ = unsafe { #span!($call, $api(_)) };
    }
}

use {
    std::string::String
    std::ffi::c_char
}

patt {
    p: warn = & p_ncurses_instr => RiskyApi {
        $call,
        $api,
    }
}

diag {
    #[derive(Diagnostic)]
    #[diag(risky_api)]
    pub struct RiskyApi {
        pub call: Span,
        pub api: Ident,
    }
}

msg {
    risky_api = usage of risky C API `{$api}`
}
````

## References

- curses: https://en.wikipedia.org/wiki/Curses_(programming_library)
- ncurses: https://en.wikipedia.org/wiki/Ncurses
- crates.io: https://crates.io/crates/ncurses
- `instr` function: https://invisible-island.net/ncurses/man/curs_instr.3x.html
